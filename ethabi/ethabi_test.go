package ethabi

import (
	"fmt"
	"io/ioutil"
	"testing"
)

/*  fixed and ufixed hasn't been implemented yet
func TestCallBar(t *testing.T) {
	contract := "Foo"
	function := "bar"
	params := "2.125,8.5"
	res := "0xab55044d00000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000880000000000000000000000000000000"

	compileRes(contract, function, params, res)
}
*/

func TestCallBaz(t *testing.T) {
	contract := "Foo"
	function := "baz"
	params := "69&true"
	res := "0xcdcd77c000000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000001"

	compileRes(contract, function, params, res)
}

func TestCallSam(t *testing.T) {
	contract := "Foo"
	function := "sam"
	params := "dave&true&1,2,3"
	res := "0xa5643bf20000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000464617665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003"

	compileRes(contract, function, params, res)
}

func TestCallF(t *testing.T) {
	contract := "Foo"
	function := "f"
	params := "291&1110,1929&1234567890&Hello, world!"
	res := "0x8be6524600000000000000000000000000000000000000000000000000000000000001230000000000000000000000000000000000000000000000000000000000000080313233343536373839300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000004560000000000000000000000000000000000000000000000000000000000000789000000000000000000000000000000000000000000000000000000000000000d48656c6c6f2c20776f726c642100000000000000000000000000000000000000"

	compileRes(contract, function, params, res)
}

func compileRes(contract, function, params, res string) {
	fmt.Println("testing ", contract, function)

	abiFile := "./testdata/Foo.abi"
	abiBytes, err := ioutil.ReadFile(abiFile)
	if err != nil {
		panic(err)
	}
	e := &EthABI{contract, abiBytes}
	def, err := e.FuncDef(function)
	if err != nil {
		panic(err)
	}
	selector := CalSelector(def)
	cp, err := e.CombineParams(function, params)
	if err != nil {
		panic(err)
	}

	r, err := CalBytes(selector, cp)
	if err != nil {
		panic(err)
	}
	if r != res {
		fmt.Println("contract:", contract)
		fmt.Println("function:", function)
		fmt.Println("params:", params)
		fmt.Println("expecting:", res)
		fmt.Println("cal res:", r)
	}
}
